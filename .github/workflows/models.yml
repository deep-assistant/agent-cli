name: Model Tests

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Provider'
        required: true
        type: choice
        default: 'opencode'
        options:
          - opencode
          - groq
      model:
        description: 'Model (from dropdown)'
        required: true
        type: choice
        default: 'grok-code'
        options:
          # OpenCode Zen models (free)
          - grok-code
          - gpt-5-nano
          - big-pickle
          # OpenCode Zen models (paid)
          - sonnet
          - haiku
          - opus
          - gemini-3-pro
          - gpt-5-1
          - qwen3-coder-480b
          # Groq models
          - llama-3.3-70b-versatile
          - llama-3.1-8b-instant
          - qwen/qwen3-32b
          - openai/gpt-oss-120b
          - openai/gpt-oss-20b
          - groq/compound
          - groq/compound-mini
          - moonshotai/kimi-k2-instruct-0905
          - meta-llama/llama-4-scout-17b-16e-instruct
          - meta-llama/llama-4-maverick-17b-128e-instruct
      custom_model:
        description: 'Custom model name (overrides dropdown if set)'
        required: false
        type: string
        default: ''
      test_type:
        description: 'Test Type'
        required: true
        type: choice
        default: 'both'
        options:
          - with_tools
          - without_tools
          - both


jobs:
  test-model:
    runs-on: ubuntu-latest
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Determine model to test
        id: model
        run: |
          CUSTOM_MODEL="${{ inputs.custom_model }}"
          MODEL_NAME="${{ inputs.model }}"
          PROVIDER="${{ inputs.provider }}"

          if [ -n "$CUSTOM_MODEL" ]; then
            MODEL_ID="$PROVIDER/$CUSTOM_MODEL"
            MODEL_NAME="$CUSTOM_MODEL"
          else
            MODEL_ID="$PROVIDER/$MODEL_NAME"
          fi

          echo "model_id=$MODEL_ID" >> $GITHUB_OUTPUT
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "Testing model: $MODEL_ID"

      - name: Fetch model capabilities
        id: capabilities
        run: |
          OUTPUT=$(node scripts/get-model-info.mjs "${{ inputs.provider }}" "${{ steps.model.outputs.model_name }}")
          echo "$OUTPUT"
          echo "$OUTPUT" >> $GITHUB_OUTPUT

      - name: Check API key availability
        run: |
          if [ "${{ inputs.provider }}" = "groq" ]; then
            if [ -z "$GROQ_API_KEY" ]; then
              echo "::warning::GROQ_API_KEY is not set. Groq tests may fail."
            else
              echo "GROQ_API_KEY is configured"
            fi
          fi

      - name: Test without tools (simple response)
        if: inputs.test_type == 'without_tools' || inputs.test_type == 'both'
        run: node scripts/test-model-simple.mjs "${{ steps.model.outputs.model_id }}"

      - name: Test with tools (tool calling)
        if: inputs.test_type == 'with_tools' || inputs.test_type == 'both'
        run: node scripts/test-model-tools.mjs "${{ steps.model.outputs.model_id }}"

      - name: Summary
        run: |
          echo "## Model Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Provider**: ${{ inputs.provider }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ steps.model.outputs.model_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type**: ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output-simple.log ]; then
            echo "### Simple Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 test-output-simple.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f test-output-tools.log ]; then
            echo "### Tool Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 test-output-tools.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

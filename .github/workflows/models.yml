name: Model Tests

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Provider'
        required: true
        type: choice
        default: 'opencode'
        options:
          - opencode
          - groq
      model:
        description: 'Model (from dropdown)'
        required: true
        type: choice
        default: 'grok-code'
        options:
          # OpenCode Zen models (free)
          - grok-code
          - gpt-5-nano
          - big-pickle
          # OpenCode Zen models (paid)
          - sonnet
          - haiku
          - opus
          - gemini-3-pro
          - gpt-5-1
          - qwen3-coder-480b
          # Groq models
          - llama-3.3-70b-versatile
          - llama-3.1-8b-instant
          - qwen/qwen3-32b
          - openai/gpt-oss-120b
          - openai/gpt-oss-20b
          - groq/compound
          - groq/compound-mini
          - moonshotai/kimi-k2-instruct-0905
          - meta-llama/llama-4-scout-17b-16e-instruct
          - meta-llama/llama-4-maverick-17b-128e-instruct
      custom_model:
        description: 'Custom model name (overrides dropdown if set)'
        required: false
        type: string
        default: ''


jobs:
  test-model:
    runs-on: ubuntu-latest
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

       - name: Determine model to test
         id: model
         run: |
           CUSTOM_MODEL="${{ inputs.custom_model }}"
           if [ -n "$CUSTOM_MODEL" ]; then
             MODEL_ID="${{ inputs.provider }}/$CUSTOM_MODEL"
           else
             MODEL_ID="${{ inputs.provider }}/${{ inputs.model }}"
           fi
           echo "model_id=$MODEL_ID" >> $GITHUB_OUTPUT
           echo "Testing model: $MODEL_ID"

       - name: Fetch model capabilities
         id: capabilities
         run: |
           PROVIDER="${{ inputs.provider }}"
           MODEL="${{ inputs.custom_model }}"
           if [ -z "$MODEL" ]; then
             MODEL="${{ inputs.model }}"
           fi

           # Fetch model data from models.dev
           MODEL_DATA=$(curl -s "https://models.dev/api.json" | jq -r ".\"$PROVIDER\".models.\"$MODEL\" // empty")

           if [ -n "$MODEL_DATA" ]; then
             TOOL_CALL=$(echo "$MODEL_DATA" | jq -r '.tool_call // false')
             echo "tool_call=$TOOL_CALL" >> $GITHUB_OUTPUT
             echo "Model supports tool calling: $TOOL_CALL"
           else
             echo "Model data not found, assuming tool_call=true for known providers"
             echo "tool_call=true" >> $GITHUB_OUTPUT
           fi

      - name: Check API key availability
        run: |
          PROVIDER="${{ inputs.provider }}"
          if [ "$PROVIDER" = "groq" ]; then
            if [ -z "$GROQ_API_KEY" ]; then
              echo "::warning::GROQ_API_KEY is not set. Groq tests may fail."
            else
              echo "GROQ_API_KEY is configured"
            fi
          fi

      - name: Test without tools (simple response)
        if: inputs.test_type == 'without_tools' || inputs.test_type == 'both'
        run: |
          echo "Testing model: ${{ steps.model.outputs.model_id }}"
          echo "Test: Simple message without tool calls"
          echo ""

          # Test simple message (no tool calls expected)
          TEST_INPUT='{"message": "What is 2 + 2? Answer with just the number."}'
          echo "$TEST_INPUT" | timeout 60s bun run src/index.js --model "${{ steps.model.outputs.model_id }}" > test-output-simple.log 2>&1 || EXIT_CODE=$?

          echo "Exit code: ${EXIT_CODE:-0}"
          echo ""
          echo "Output:"
          cat test-output-simple.log

          # Check for success
          if [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo ""
            echo "✅ Simple test PASSED"
          elif [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo ""
            echo "⚠️ Test timed out (may still be valid for some models)"
          else
            echo ""
            echo "❌ Simple test FAILED with exit code ${EXIT_CODE:-0}"
            exit 1
          fi

      - name: Test with tools (tool calling)
        if: inputs.test_type == 'with_tools' || inputs.test_type == 'both'
        run: |
          echo "Testing model: ${{ steps.model.outputs.model_id }}"
          echo "Test: Message expecting tool call"
          echo ""

          # Test message that should trigger tool use
          TEST_INPUT='{"message": "List the files in the current directory using the bash tool with ls command"}'
          echo "$TEST_INPUT" | timeout 90s bun run src/index.js --model "${{ steps.model.outputs.model_id }}" > test-output-tools.log 2>&1 || EXIT_CODE=$?

          echo "Exit code: ${EXIT_CODE:-0}"
          echo ""
          echo "Output:"
          cat test-output-tools.log

          # Check for tool_use event in output
          if grep -q '"type":"tool_use"' test-output-tools.log || grep -q '"type": "tool_use"' test-output-tools.log; then
            echo ""
            echo "✅ Tool use detected in output"
          else
            echo ""
            echo "⚠️ No tool_use event found (model may not support tool calling or chose not to use tools)"
          fi

          # Check for success
          if [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo ""
            echo "✅ Tool test PASSED"
          elif [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo ""
            echo "⚠️ Test timed out (may still be valid for complex tool operations)"
          else
            echo ""
            echo "❌ Tool test FAILED with exit code ${EXIT_CODE:-0}"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Model Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Provider**: ${{ inputs.provider }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ steps.model.outputs.model_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type**: ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output-simple.log ]; then
            echo "### Simple Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 test-output-simple.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f test-output-tools.log ]; then
            echo "### Tool Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 test-output-tools.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
